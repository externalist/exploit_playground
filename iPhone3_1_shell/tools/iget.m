@import Foundation;
#include <sys/types.h>          /* See NOTES */
#include <sys/socket.h>


NSData *download(NSString *_url)
{
	NSURL  *url = [NSURL URLWithString:_url];
	NSData *urlData = [NSData dataWithContentsOfURL:url];
	if (urlData != nil)
		printf("got len: %d bytes\n", [urlData length]);
	else
		printf("failed\n");

	return urlData;
}

int main(int argc, char **argv)
{
	if (argc != 3) {
		printf("Usage: %s <source url> <dest path>\n", argv[0]);
		return 0;
	}

	printf("downloading %s\n", argv[1]);
	NSString *url = [NSString stringWithUTF8String:argv[1]];
	NSData *data = download(url);
	if (data == nil)
		return -1;

	int fd = open(argv[2], O_CREAT | O_RDWR,
		       	S_IRUSR | S_IXUSR | S_IWUSR |
			S_IRGRP | S_IXGRP |
			S_IROTH | S_IXOTH
			); 
	if (fd < 0) {
		printf("could not create %s\n", argv[2]);
		return -1;
	}

	int ret = write(fd, [data bytes], [data length]);
	if (ret != [data length]) {
		printf("write to %s, failed\n", argv[2]);
		perror(NULL);
		return -1;
	}
	printf("saved to %s\n", argv[2]);
	close(fd);
	sync();
}

